# ?? Shop Microservices - End-to-End Tests

Scripts de testes end-to-end para validar a integração entre os microserviços.

## ?? Pré-requisitos

- Docker Compose rodando com todos os serviços **healthy**
- **Bash** (Linux/macOS/WSL) ou **PowerShell** (Windows)
- **curl** instalado

## ?? Executar os Testes

### Linux/macOS/WSL (Bash)

```bash
# Dar permissão de execução
chmod +x tests/e2e-tests.sh

# Executar testes
./tests/e2e-tests.sh
```

### Windows (PowerShell)

```powershell
# Executar testes
.\tests\e2e-tests.ps1

# Com delay customizado (em milissegundos)
.\tests\e2e-tests.ps1 -DelayMs 1000
```

## ?? Cenários de Teste

### Cenário 1: Fluxo Completo de Compra ??

1. ? Criar categoria "Electronics"
2. ? Criar produto "Laptop Gamer"
3. ? Criar produto "Gaming Mouse"
4. ? Listar todos os produtos
5. ? Adicionar Laptop ao carrinho do user123
6. ? Adicionar Mouse ao carrinho do user123
7. ? Obter carrinho e validar total
8. ? Criar pedido com itens do carrinho
9. ? Verificar pedido criado
10. ? Atualizar status para "Confirmed"

### Cenário 2: Validações ??

1. ? Criar produto com dados inválidos (deve retornar 400)
2. ? Criar produto sem nome (deve retornar 400)
3. ? Adicionar item com quantidade negativa (deve retornar 400)
4. ? Criar pedido sem itens (deve retornar 400)
5. ? Criar pedido sem userId (deve retornar 400)
6. ? Obter pedido inexistente (deve retornar 404)

### Cenário 3: Limpeza ??

1. ? Limpar carrinho do user123
2. ? Verificar que carrinho está vazio
3. ? Criar pedido para teste de cancelamento
4. ? Cancelar pedido
5. ? Verificar status "Cancelled"

## ?? Output Esperado

```
?????????????????????????????????????????????????????????????????????
?   ?? SHOP MICROSERVICES - END-TO-END TESTS                       ?
?????????????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????????
  ?? VERIFICAÇÃO DE SAÚDE DOS SERVIÇOS
???????????????????????????????????????????????????????????????????

? TEST: Catalog API Health Check
  ? PASS: Catalog API está healthy
? TEST: Basket API Health Check
  ? PASS: Basket API está healthy
? TEST: Ordering API Health Check
  ? PASS: Ordering API está healthy

... (mais testes) ...

???????????????????????????????????????????????????????????????????
  ?? RESUMO DOS TESTES
???????????????????????????????????????????????????????????????????

  ? Testes Passaram:  25
  ? Testes Falharam:  0
  ?? Total de Testes:  25

???????????????????????????????????????????????????????????????????
  ?? TODOS OS TESTES PASSARAM!
???????????????????????????????????????????????????????????????????
```

## ?? APIs Testadas

| API | URL | Health Check |
|-----|-----|--------------|
| Catalog API | http://localhost:5001 | /health |
| Basket API | http://localhost:5002 | /health |
| Ordering API | http://localhost:5003 | /health |

## ?? Endpoints Testados

### Catalog API
- `GET /api/products` - Listar produtos
- `POST /api/products` - Criar produto
- `GET /api/categories` - Listar categorias
- `POST /api/categories` - Criar categoria

### Basket API
- `GET /api/basket/{userId}` - Obter carrinho
- `POST /api/basket/{userId}/items` - Adicionar item
- `DELETE /api/basket/{userId}` - Limpar carrinho

### Ordering API
- `GET /api/orders` - Listar pedidos
- `GET /api/orders/{id}` - Obter pedido
- `POST /api/orders` - Criar pedido
- `PUT /api/orders/{id}/status` - Atualizar status
- `DELETE /api/orders/{id}` - Cancelar pedido

## ?? Troubleshooting

### Serviços não estão healthy

```bash
# Verificar status dos containers
docker-compose ps

# Ver logs de um serviço específico
docker-compose logs -f catalog-api
```

### Erro de conexão recusada

```bash
# Verificar se os serviços estão rodando nas portas corretas
curl http://localhost:5001/health
curl http://localhost:5002/health
curl http://localhost:5003/health
```

### Testes falhando por timeout

Aumente o delay entre requests:

```powershell
# PowerShell
.\tests\e2e-tests.ps1 -DelayMs 2000
```

```bash
# Bash - editar a variável DELAY_MS no script
DELAY_MS=2000
```

## ?? Exit Codes

| Código | Significado |
|--------|-------------|
| 0 | Todos os testes passaram |
| 1 | Um ou mais testes falharam |

## ?? Links Úteis

- [Swagger - Catalog API](http://localhost:5001/swagger)
- [Swagger - Basket API](http://localhost:5002/swagger)
- [Swagger - Ordering API](http://localhost:5003/swagger)
- [Seq - Logs](http://localhost:5341)
- [RabbitMQ Management](http://localhost:15672)
